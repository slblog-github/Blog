const CACHE_NAME="BlogCache";let cachelist=[];self.db={read:(t,e)=>(e||(e={type:"text"}),new Promise(((e,n)=>{caches.open(CACHE_NAME).then((n=>{n.match(new Request(`https://LOCALCACHE/${encodeURIComponent(t)}`)).then((function(t){t||e(null),t.text().then((t=>e(t)))})).catch((()=>{e(null)}))}))}))),write:(t,e)=>new Promise(((n,a)=>{caches.open(CACHE_NAME).then((function(a){a.put(new Request(`https://LOCALCACHE/${encodeURIComponent(t)}`),new Response(e)),n()})).catch((()=>{a()}))}))},self.addEventListener("fetch",(async t=>{try{t.respondWith(handle(t.request))}catch(e){t.respondWith(handleerr(t.request,e))}}));const handleerr=async(t,e)=>new Response(`<h1>BlogHelper Error</h1>\n    <b>${e}</b>`,{headers:{"content-type":"text/html; charset=utf-8"}});let cdn={gh:{jsdelivr:{url:"https://cdn1.tianli0.top/gh"},pigax_jsd:{url:"https://u.pigax.cn/gh"},pigax_chenyfan_jsd:{url:"https://cdn-jsd.pigax.cn/gh"},oplog:{url:"https://cdn.oplog.cn/gh"}},combine:{jsdelivr:{url:"https://cdn1.tianli0.top/combine"},pigax_jsd:{url:"https://u.pigax.cn/combine"},pigax_chenyfan_jsd:{url:"https://cdn-jsd.pigax.cn/combine"},cnortles:{url:"https://cdn.cnortles.top/combine"},hin_cool:{url:"https://jsd.hin.cool/combine"}},npm:{eleme:{url:"https://npm.elemecdn.com"},jsdelivr:{url:"https://cdn1.tianli0.top/npm"},oplog:{url:"https://cdn.oplog.cn/npm"},zhimg:{url:"https://unpkg.zhimg.com"},unpkg:{url:"https://unpkg.com"},bdstatic:{url:"https://code.bdstatic.com/npm"},pigax_jsd:{url:"https://u.pigax.cn/npm"},pigax_unpkg:{url:"https://unpkg.pigax.cn/"},pigax_chenyfan_jsd:{url:"https://cdn-jsd.pigax.cn/npm"}}};const cache_url_list=[/(http:\/\/|https:\/\/)rmt\.ladydaily\.com/g,/(http:\/\/|https:\/\/)rmt\.dogedoge\.com/g],blog={local:0,origin:["blog.slqwq.cn"],plus:["blog.slqwq.cn","gcores.blog.slqwq.cn","deno.blog.slqwq.cn","hajeekns-blog.pages.dev","vercel.blog.slqwq.cn"]},blacklist=["9b5aee25-1d5b-4be8-9ea6-55651bfef4bc","0e7e3e61-20b4-414b-ae6b-577b6f25ee54"],handle=async function(t){await t.clone();const e=t.url;let n=new URL(e);const a=n.href.substr(n.origin.length),s=(n.port,e.split("/")[2]);if(a.match(/\/sw\.js/g))return fetch(t);if(a.match("/cdn-cgi/"))return new Response(null,{status:308});a.split("?")[0];const r=t=>n.searchParams.get(t);let c=[],i=JSON.parse(await db.read("msg"))||(async()=>(await db.write("msg","[]"),"[]"))();const l=e.split("?")[0],o=new Request(l),h=async t=>{const e=await caches.open(CACHE_NAME);await e.delete(t)};if("true"==r("nosw"))return fetch(t);if("true"==r("delete"))return h(o),i.push({name:"文件已删除",time:new Date,info:`已删除${l}`}),await db.write("msg",JSON.stringify(i)),new Response(JSON.stringify({ok:1}));if("true"==r("forceupdate"))return i.push({name:"文件已强制更新",time:new Date,info:`已更新${l}`}),await db.write("msg",JSON.stringify(i)),await fetch(t).then((function(e){return caches.open(CACHE_NAME).then((function(n){return h(o),n.put(t,e.clone()),e}))})),new Response(JSON.stringify({ok:1}));for(let n in cdn)for(let a in cdn[n])if(s==cdn[n][a].url.split("https://")[1].split("/")[0]&&e.match(cdn[n][a].url)){c=[];for(let t in cdn[n])c.push(e.replace(cdn[n][a].url,cdn[n][t].url));return caches.match(t).then((function(n){return n||lfetch(c,e).then((function(e){return caches.open(CACHE_NAME).then((function(n){return n.put(t,e.clone()),e}))}))}))}for(var p in blog.origin)if(s.split(":")[0]==blog.origin[p].split(":")[0]){if(e.match(/\/blog\-cgi/g))return handlecgi(t);if(blog.local)return fetch(t);c=[];for(let t in blog.plus)c.push(`https://${blog.plus[t]}`+fullpath(a));for(let t in blog.npmmirror)c.push(blog.npmmirror[t]+fullpath(a));return new Promise(((n,s)=>{setTimeout((()=>{caches.match(t).then((function(s){s?(setTimeout((()=>{n(s)}),200),setTimeout((()=>{lfetch(c,e).then((async function(e){return caches.open(CACHE_NAME).then((async function(s){if(s.delete(t),fullpath(a).match(/\.html$/g)){const a=new Response(await e.arrayBuffer(),{headers:{"Content-Type":"text/html;charset=utf-8"},status:e.status,statusText:e.statusText});s.put(t,a.clone()),n(a)}else s.put(t,e.clone()),n(e)}))}))}),0)):(setTimeout((()=>{lfetch(c,e).then((async function(e){return caches.open(CACHE_NAME).then((async function(s){if(fullpath(a).match(/\.html$/g)){const a=new Response(await e.arrayBuffer(),{headers:{"Content-Type":"text/html;charset=utf-8"},status:e.status,statusText:e.statusText});s.put(t,a.clone()),n(a)}else s.put(t,e.clone()),n(e)}))})).catch((function(t){n(caches.match(new Request("https://blog.slqwq.cn/Helper/")))}))}),0),setTimeout((()=>{n(caches.match(new Request("https://blog.slqwq.cn/Helper/")))}),5e3))}))}),0)}))}for(var p in cache_url_list)if(e.match(cache_url_list[p]))return caches.match(t).then((function(e){return e||fetch(t).then((function(e){return caches.open(CACHE_NAME).then((function(n){return n.put(t,e.clone()),e}))}))}));return fetch(t)},lfetch=async(t,e)=>{Promise.any||(Promise.any=function(t){return new Promise(((e,n)=>{let a=(t=Array.isArray(t)?t:[]).length,s=[];if(0===a)return n(new AggregateError("All promises were rejected"));t.forEach((t=>{t.then((t=>{e(t)}),(t=>{a--,s.push(t),0===a&&n(new AggregateError(s))}))}))}))});let n=new AbortController;const a=async t=>new Response(await t.arrayBuffer(),{status:t.status,headers:t.headers});let s=Promise.any(t.map((async t=>new Promise((async(e,s)=>{fetch(t,{signal:n.signal}).then(a).then((async a=>{const r=a.clone();200==r.status?(setTimeout((async()=>{db.write("HIT_HOT",await(async()=>{const e=await(async()=>{try{return JSON.parse(await db.read("HIT_HOT"))||{site:{},static:{}}}catch(t){return{site:{},static:{}}}})(),n=t.split("/")[2];return blog.plus.indexOf(n)>-1?e.site[n]=e.site[n]?e.site[n]+1:1:e.static[n]=e.static[n]?e.static[n]+1:1,JSON.stringify(e)})()),db.write("HIT_HOT_SIZE",await(async()=>{const e=await(async()=>{try{return JSON.parse(await db.read("HIT_HOT_SIZE"))||{site:{},static:{}}}catch(t){return{site:{},static:{}}}})(),n=t.split("/")[2];return blog.plus.indexOf(n)>-1?e.site[n]=e.site[n]?e.site[n]+Number(a.headers.get("Content-Length")):Number(a.headers.get("Content-Length")):e.static[n]=e.static[n]?e.static[n]+Number(a.headers.get("Content-Length")):Number(a.headers.get("Content-Length")),JSON.stringify(e)})())}),0),n.abort(),e(r)):s(null)})).catch((()=>{s(null)}))}))))).then((t=>t)).catch((()=>null));return s},handlecgi=async e=>{const n=t=>t<1024?`${t}B`:t<1048576?`${(t/1024).toFixed(2)}KB`:t<1073741824?`${(t/1024/1024).toFixed(2)}MB`:`${(t/1024/1024/1024).toFixed(2)}GB`,a=e.url;let s=new URL(a);s.href.substr(s.origin.length);const r="https://npm.elemecdn.com/chenyfan-blog-helper-dash@0.0.7/";let c=await(await fetch(r+"index.html")).text();const i=await(async()=>{try{return JSON.parse(await db.read("HIT_HOT"))||{}}catch(t){return{}}})(),l=await(async()=>{try{return JSON.parse(await db.read("HIT_HOT_SIZE"))||{}}catch(t){return{}}})(),h=(()=>{p={};for(let t in i.site)p[t]=i.site[t];for(let t in i.static)p[t]=i.static[t];return p})(),u=(()=>{p={};for(let t in l.site)p[t]=l.site[t];for(let t in l.static)p[t]=l.static[t];return p})();let g=await(await fetch(r+"part/message.html")).text(),d=JSON.parse(await db.read("msg"))||[];console.log(d);const f=(()=>{let t="";for(let e in d.reverse())t+=g.replace(/<!--NAME-->/g,d[e].name).replace(/<!--TIME-->/g,d[e].time).replace(/<!--INFO-->/g,d[e].info);return console.log(t),t})();switch(c=c.replace(/<!--MESSAGE-->/g,f),m="dash",s.searchParams.get(m)){case"test":let e=await(await fetch(r+"content/test.html")).text();return new Response(c.replace(/<!--TEST_ACTIVE-->/g," active").replace(/<!--SECTION-->/g,e),{headers:{"Content-Type":"text/html"}});case"cache":let a=await(await fetch(r+"part/cache.html")).text(),s=await(await fetch(r+"content/cache.html")).text();const i=await new Promise(((e,n)=>{let a=[];caches.open(CACHE_NAME).then((async n=>{n.keys().then((async s=>{for(var r in s){if(t={},t.url=s[r].url,t.url.match("https://localcache/"))continue;const e=await n.match(s[r]);t.size=Number(e.headers.get("content-length")),t.time=s[r].headers.get("last-modified")||e.headers.get("last-modified"),a.push(t)}e(a)}))}))})),l=(()=>{let t=0;for(let e in i)t+=1;return t})();console.log(l);const p=(()=>{t=0;for(let e in i)t+=i[e].size;return t})();return new Response(c.replace(/<!--CACHE_ACTIVE-->/g," active").replace(/<!--SECTION-->/g,s).replace(/<!--CACHE_COUNT-->/g,l).replace(/<!--CACHE_SIZE_COUNT-->/g,n(p)).replace(/<!--INFO-->/g,(()=>{for(var t in o="",i)o+=a.replace(/<!--URL-->/g,i[t].url).replace(/<!--SIZE-->/g,n(i[t].size)).replace(/<!--TIME-->/g,i[t].time).replace(/<!--CACHE_ROUND-->/g,(i[t].size/p*100).toFixed(2));return o})()),{status:200,headers:{"Content-Type":"text/html"}});default:let g=await(await fetch(r+"part/info.html")).text(),d=await(await fetch(r+"content/main.html")).text();const f=Math.round(Object.keys(h).reduce(((t,e)=>t+h[e]),0)),m=Math.round(Object.keys(u).reduce(((t,e)=>t+u[e]),0));return new Response(c.replace(/<!--HOME_ACTIVE-->/g,"active").replace(/<!--SECTION-->/g,d).replace(/<!--HIT_COUNT-->/g,f).replace(/<!--HIT_SIZE_COUNT-->/g,n(m)).replace(/<!--INFO-->/g,(()=>{for(var e in t="",h)t+=g.replace(/<!--DOMAIN-->/g,e).replace(/<!--HIT_COUNT-->/g,h[e]).replace(/<!--HIT_SIZE_COUNT-->/g,n(u[e])).replace(/<!--HIT_ROUND-->/g,(u[e]/m*100).toFixed(2)).replace(/<!--TYPE-->/g,blog.plus.indexOf(e)>-1?"源站":"静态资源");return t})()),{headers:{"content-type":"text/html; charset=utf-8"}})}var m},fullpath=t=>((t=t.split("?")[0].split("#")[0]).match(/\/$/)&&(t+="index"),t.match(/\.[a-zA-Z]+$/)||(t+=".html"),t);